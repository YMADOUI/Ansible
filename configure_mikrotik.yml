---
- name: Configuration automatique Mikrotik wAP 60G
  hosts: localhost
  gather_facts: yes
  vars_prompt:
    - name: topos_username
      prompt: "Entrez votre nom d'utilisateur TOPOS"
      private: no

    - name: topos_password
      prompt: "Entrez votre mot de passe TOPOS"
      private: yes

    - name: site_id
      prompt: "Entrez le numéro d'installation (site)"
      private: no

    - name: device_mode
      prompt: "Type de configuration (MASTER ou SLAVE)"
      private: no
      default: "MASTER"

  tasks:
    - name: Vérifier le mode saisi
      fail:
        msg: "Le mode doit être MASTER ou SLAVE"
      when: device_mode not in ['MASTER', 'SLAVE', 'master', 'slave']

    - name: Normaliser le mode
      set_fact:
        normalized_mode: "{{ device_mode | upper }}"

    - name: "Étape 1/6 - Connexion à l'API TOPOS"
      topos_api:
        action: login
        username: "{{ topos_username }}"
        password: "{{ topos_password }}"
      register: login_result
      no_log: false

    - name: Afficher le résultat de connexion
      debug:
        msg: "Connexion réussie - Token récupéré"
      when: login_result.token is defined

    - name: Sauvegarder le token
      set_fact:
        api_token: "{{ login_result.token }}"

    - name: "Étape 2/6 - Récupération des informations du site"
      topos_api:
        action: get_site_info
        token: "{{ api_token }}"
        site_id: "{{ site_id }}"
      register: site_info
      no_log: false

    - name: Afficher les informations du site
      debug:
        var: site_info.site_info
      when: site_info.site_info is defined

    - name: Extraire les données du site
      set_fact:
        site_data: "{{ site_info.site_info.data | default(site_info.site_info) }}"

    - name: Définir les variables du site
      set_fact:
        NUMINSTALLATION: "{{ site_data.installation_number | default(site_id) }}"
        TOPOSSNMP: "{{ site_data.snmp_community | default(site_data.community | default('public')) }}"
        TOPOSRW: "{{ site_data.rw_password | default(site_data.password | default('admin')) }}"

    - name: "Étape 3/6 - Récupération de la liste des équipements"
      topos_api:
        action: list_equipments
        token: "{{ api_token }}"
        site_id: "{{ site_id }}"
      register: equipments_list
      no_log: false

    - name: Extraire la liste des équipements
      set_fact:
        equipments: "{{ equipments_list.equipments.data | default(equipments_list.equipments) }}"

    - name: Afficher la liste des équipements
      debug:
        msg: "{{ idx }}. {{ item.name | default(item.hostname | default('Équipement sans nom')) }} - ID: {{ item.id }} - Type: {{ item.type | default('N/A') }}"
      loop: "{{ equipments if equipments is iterable and equipments is not string else [] }}"
      loop_control:
        index_var: idx
        label: "Equipment {{ idx }}"

    - name: Demander le choix de l'équipement
      pause:
        prompt: "Entrez le numéro de l'équipement à configurer (0 pour le premier)"
      register: equipment_choice

    - name: Sélectionner l'équipement
      set_fact:
        selected_equipment: "{{ equipments[equipment_choice.user_input | int] }}"

    - name: Afficher l'équipement sélectionné
      debug:
        msg: "Équipement sélectionné: {{ selected_equipment.name | default(selected_equipment.hostname | default('N/A')) }}"

    - name: "Étape 4/6 - Récupération des informations de l'équipement"
      topos_api:
        action: get_equipment_info
        token: "{{ api_token }}"
        equipment_id: "{{ selected_equipment.id }}"
      register: equipment_info
      no_log: false

    - name: Extraire les données de l'équipement
      set_fact:
        equipment_data: "{{ equipment_info.equipment_info.data | default(equipment_info.equipment_info) }}"

    - name: Définir les variables de l'équipement
      set_fact:
        TOPOSHOSTNAME: "{{ equipment_data.hostname | default(equipment_data.name | default('mikrotik-wap60g')) }}"
        IPADDR: "{{ equipment_data.ip_address | default(equipment_data.ip | default('192.168.88.2')) }}"
        TOPOSIP: "{{ equipment_data.management_ip | default(equipment_data.ip_address | default(equipment_data.ip | default('10.10.1.1'))) }}"
        NEWSSID: "{{ equipment_data.ssid | default('TOPOS-' + site_id) }}"

    - name: Définir le mode de configuration
      set_fact:
        MODE: "{{ 'bridge' if normalized_mode == 'MASTER' else 'station-bridge' }}"

    - name: "Étape 5/6 - Génération de la configuration"
      template:
        src: templates/mikrotik_config.j2
        dest: "./mikrotik_config_{{ TOPOSHOSTNAME }}.rsc"
      delegate_to: localhost

    - name: Afficher le récapitulatif de la configuration
      debug:
        msg:
          - "============================================"
          - "Configuration générée avec succès !"
          - "============================================"
          - "Site: {{ NUMINSTALLATION }}"
          - "Équipement: {{ TOPOSHOSTNAME }}"
          - "IP: {{ IPADDR }}"
          - "IP Management: {{ TOPOSIP }}"
          - "SSID: {{ NEWSSID }}"
          - "Mode: {{ MODE }} ({{ normalized_mode }})"
          - "SNMP Community: {{ TOPOSSNMP }}"
          - "============================================"
          - "Fichier généré: mikrotik_config_{{ TOPOSHOSTNAME }}.rsc"
          - "============================================"

    - name: Demander confirmation pour appliquer la configuration
      pause:
        prompt: "Voulez-vous appliquer cette configuration sur l'équipement Mikrotik à 192.168.88.2 ? (yes/no)"
      register: apply_confirmation

    - name: "Étape 6/6 - Application de la configuration sur Mikrotik"
      block:
        - name: Copier la configuration sur le Mikrotik via SCP
          shell: |
            scp -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null mikrotik_config_{{ TOPOSHOSTNAME }}.rsc admin@192.168.88.2:/
          environment:
            SSHPASS: "{{ TOPOSRW }}"
          delegate_to: localhost
          ignore_errors: yes
          register: scp_result

        - name: Appliquer la configuration via SSH
          shell: |
            ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null admin@192.168.88.2 "/import mikrotik_config_{{ TOPOSHOSTNAME }}.rsc"
          environment:
            SSHPASS: "{{ TOPOSRW }}"
          delegate_to: localhost
          ignore_errors: yes
          register: ssh_result

        - name: Afficher le résultat
          debug:
            msg:
              - "Configuration appliquée !"
              - "Veuillez vérifier l'équipement à l'adresse: https://{{ TOPOSIP }}"
              - "Ou à l'adresse par défaut: https://192.168.88.2"
      
      when: apply_confirmation.user_input | lower in ['yes', 'y', 'oui', 'o']

    - name: Configuration non appliquée
      debug:
        msg: "Configuration sauvegardée dans mikrotik_config_{{ TOPOSHOSTNAME }}.rsc mais non appliquée."
      when: apply_confirmation.user_input | lower not in ['yes', 'y', 'oui', 'o']
